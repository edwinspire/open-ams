<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: uDCGrid/uDCGrid.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: uDCGrid/uDCGrid.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**

 * Handles elements

 * @namespace OpenMonitoringSystem

 */
define(["dojo/_base/declare", 
    "dojo/on",
    "dojo/window",
    "dojo/dom-class",
    'dojo/has',
    "dgrid/OnDemandGrid",     
    'dgrid/Keyboard',
    'dstore/Memory',
    'dstore/Trackable',
    'dgrid/Selection',
    'dgrid/Selector',
    'dgrid/extensions/Pagination',
    'dgrid/Editor',
    'dgrid/extensions/ColumnReorder',
    'dgrid/extensions/ColumnResizer',
    'dgrid/extensions/ColumnHider',
    'dojo/request',
    "dojo/_base/array",
    "dojo/topic",
    "dojo/Deferred",
    'dstore/Filter',
    "dijit/form/TextBox",
    "dijit/form/CheckBox",
    "dijit/form/HorizontalSlider",
    "dijit/form/VerticalSlider",
    "dijit/form/NumberSpinner",
    "dojox/form/TimeSpinner",
    "dijit/form/CurrencyTextBox",
    "dijit/form/DateTextBox",
    "dijit/form/NumberTextBox",
    "dijit/form/SimpleTextarea",
    "dijit/form/Textarea",
    "dijit/form/TimeTextBox",
    "dijit/form/FilteringSelect",
    "FilteringSelectGlobalStore/FilteringSelectGlobalStore",
    "Switch/Switch",
    "dojo/parser",
    "dojo/has!touch?dojo/touch:dojo/mouse"
    ], function(declare, on, win, domClass, has, Grid, Keyboard, Memory, Trackable, Selection, Selector, Pagination, Editor, ColumnReorder, ColumnResizer, ColumnHider, request, array, topic, Deferred, Filter, TextBox, CheckBox,  HorizontalSlider, VerticalSlider, NumberSpinner, TimeSpinner, CurrencyTextBox, DateTextBox, NumberTextBox, SimpleTextarea, Textarea, TimeTextBox, FilteringSelect, FilteringSelectGlobalStore, Switch) {
    /**
     * Micro Data Connector dGrid
     *
     * @module uDCGrid/uDCGrid
     */
       return declare("uDCGrid/uDCGrid", [Grid, Keyboard, Selection, Selector, Pagination, Editor, ColumnReorder, ColumnResizer, ColumnHider], {

        allowTextSelection: true,
        deselectOnRefresh: false,
        allowTextSelection: true,
        allowSelectAll: true,
             //   selectionMode: t.Config.selectionMode,
             noDataMessage: "No hay datos para mostrar!",
             loadingMessage: "Cargando...",
             rowsPerPage: 20,
             pageSizeOptions: [20, 40, 80, 160, 320, 500],
             className: 'dgrid-autoheight',
               _waiting_select: false,
                _GridFieldsToFilter: [],
                _GridStore: {},
                idProperty: '',
                refreshMode: 0,
                autoUpdateRow: false,
                uDCColumns: {target: '', fields: []},
                target: 'target.json',
                refreshOnTableChanged: [],
                _array_subscribe: [],
                _last_select: {},
                table: '',
                initialQuery: {},
                _GridFieldsToFilter: [],
                rowFingerPrint: '',
                _searchTerm: '',
                _enabledload: false,
                uDCProperties: {},
    /**
     * @class uDCGrid
     * @param args {object}
              * @property {string}  hiddenFields - Id del contenedor donde se buscaran los campos que tengan el selectorClass
         * @property {string}  fieldTypes - Id del contenedor donde se buscaran los campos que tengan el selectorClass
         * @property {string}  target - Url donde apunta para obtener o enviar datos 
         * @property {string}  table - Tabla a la cual esta vinculado este uDC
         * @property {integer}  idProperty - Nombre del campo que se usa como referecia.
         * @property {string}  nodeContainer - Id del contenedor donde se buscaran los campos que tengan el selectorClass        
         * @property {string}  selectorClass - Selector CSS para buscar los campos que van a pertenecer a este uDC
         * @property {string}  targetFieldtypes - Url de donde se obtendran los tipos de datos de cada campo
     */
                constructor: function(args){
                  dojo.safeMixin(this, args);
              },
              postCreate:function (args){
                this.inherited(arguments);

                var t = this; 

                t._last_select = t.initialQuery;

//** Crea el store para los datos **//
this._GridStore = new (declare([Memory, Trackable]))({ data: null, idProperty: this.idProperty });

//** Subscribe a los eventos de cambio de datos en X tablas **//
if (Object.prototype.toString.call(t.refreshOnTableChanged) === '[object Array]') {

    array.forEach(t.refreshOnTableChanged, function(item, i){

     //console.debug('Subscribe a cambios en la tabla '+item);


     t._array_subscribe.push(topic.subscribe("/event/table/changed/"+item, function(data){
       // console.debug('La tabla '+item+' y se ha capturado el evento en la tabla');
       t.Select(t._last_select);
      //console.debug('La tabla '+item+' ha cambiado y la Grid se ha actualizado');
  }));
 });

}


//** Obtiene la estructura de las columnas **//
t.getProperties();

 //**  **//
 t.on('dgrid-datachange', function (event) {
                // var cell = grid.cell(evt);
                console.log('los datos de una fila han cambiado');



                var data = {};
                data[t.idProperty] = event.cell.row.id;

                data[event.cell.column.field] = event.value;

                if (t.rowFingerPrint) {
                    try {
                        data['UdcRowFingerPrint'] = t.rowFingerPrint;
                        data['UdcRowFingerPrintValue'] = event.cell.row.data[t.rowFingerPrint];
                    } catch (e) {
                        console.error(e);
                    }
                }

                t.Update(data);



            });

},
disabled: function(_disable){

    if(_disable){
        domClass.add(this.domNode, "element-disabled");
    }else{
        domClass.remove(this.domNode, "element-disabled");
    }
    return this;
},
Filter: function (searchTerm) {

    //console.log('Filtar por: ' + searchTerm);

    var t = this;
    t._searchTerm = searchTerm;

    var setToMemory;
            // if the search is empty, "turn off" filter
            if (t._searchTerm === "") {
                setToMemory = t._GridStore;
            } else {
                var mainFilter;
                // go though each column, applying the filter for each:
                array.forEach(t._GridFieldsToFilter, function (columnName) {

                    var filter = new Filter().match(columnName, new RegExp(t._searchTerm + "+", "i"));
                    //console.log(filter);
                    if (mainFilter) {
                        mainFilter = new Filter().or(mainFilter, filter);
                    } else {
                        mainFilter = filter;
                    }
                });
                setToMemory = t._GridStore.filter(mainFilter);
            }

            t.set("collection", setToMemory);
        },
        
        Select: function (_data, _clear_grid_before) {
            var t = this;
         //   console.log(_data);
         _clear_grid_before = _clear_grid_before || false;
if(_clear_grid_before){
t.Clear();
}

         if (_data) {

            if(t._enabledload){

                t._enabledload = false;
                t._waiting_select = false;
                t._last_select = _data;
             //   console.log(t._enabledload, t.refreshMode);
             if (!(t.refreshMode == 2 || t.refreshMode == 3)) {
              return t.request(_data, "select_rows");
          }else{
             console.warn('Select no esta habilitado ', t.refreshMode);
         }

     }else{
console.debug('Se pone un select en espera al momento no habilitado');
        t._waiting_select = _data;
    }

} else {
    console.warn('La tabla requiere datos para hacer un select', _data, t._last_select);
}

deferred = new Deferred();
deferred.resolve("success");
return deferred.promise;

},
        // Esta funcion es universal y sirve para enviar o recibir datos desde el servidor
        request: function (_param, _action) {
            var t = this;
            var _data = {};

            if (_param) {
                _data = _param;
            }

            _data.UdcAction = _action;
            _data.UdcTable = t.table;
            _data.UdcIdProperty = t.idProperty;

//console.log(t.target, _data);

if (t.target) {

    var r = request.post(t.target, {
        data: _data,
        preventCache: true,
                    // Parse data from xml
                    handleAs: "json"
                }
                ).then(
                function (response) {
                    //    console.log(response);
                    switch (_action) {
                        case "update":

//t.Clear();

if (response.rowCount > 0) {
    t.save();
    t._notifications({ Urgency: 10, Message: 'Update ' + response.rowCount + ' row(s)', Title: 'Registro actualizado' });
} else {
    t.revert();
//                                    t.Select(t._last_select);
t._notifications({ Urgency: 2, Message: response.Error, Title: 'Registro no actualizado' });
}


break;
case "select_rows":
var myData = {
    identifier: "unique_id", items: []
};

array.forEach(response, function (item, i) {
    var item_temp = item;
    item_temp.unique_id = i + 1;
                                  //  console.debug(item_temp);
                                  myData.items.push(item_temp);
                              });

t._grid_setData(myData.items);

break;
case "delete_rows":

if (response.Delete > 0) {
    t._notifications({ Urgency: 10, Message: 'Delete ' + response.Delete + ' row(s)', Title: 'Registro eliminado' });
} else {
    t._notifications({ Urgency: 2, Message: response.error, Title: 'Registro no eliminado' });
}

break;
default:
                                // t.emit('onresponseserver', response);
                                break;
                            }


                        },
                        function (error) {
                            console.warn(error);
                            switch(error.response.status){
                                case 404:
                                t._notifications({ Urgency: 2, Message: error.response.url+' no encontrada', Title: 'Error 404' });
                                break;
                                case 500:
                                if(error.response.data){
                                    switch(_action){
                                        case 'update':
                                        t.revert();
                                        t._notifications({ Urgency: 1, Message: 'Error '+error.response.data.data.code, Title: 'No se pudo actualizar' });
                                        break;
                                        default:
                                        t._notifications({ Urgency: 1, Message: 'Error '+error.response.data.data.code, Title: 'Error en el servidor' });
                                        break;
                                    }

                                }
                                break;

                            }
                        }



                        
                       //console.warn(error + " in " + t.target, _data);

                       );

                r.then(function(){
                //    domClass.replace(t.Refresh, "grid_icon_refresh_white", "grid_icon_refresh_blue grid_icon_refresh_green grid_icon_refresh_green grid_icon_refresh_yellow grid_icon_refresh_red");
                t._enabledload = true;
                switch(_action){
                    case 'update':
                                       // t.revert();
                                       t.Select(t._last_select);
                                      //  t._notifications({ Urgency: 1, Message: 'Error '+error.response.data.data.code, Title: 'No se pudo actualizar' });
                                      break;
                                      case 'select_rows':
                                      t._enabledload = true;
                                     // t.resize();
                                      if(t._waiting_select){
console.debug('Select en espera va a procesarse '+t.table);
                                       t.Select(t._waiting_select);
                                   }
                                   break;
                               }

                    	//t.resize();
                    });


            } else {
                t._enabledload = true;
                console.warn('No ha definido un Target = ', t.target);
            }
            return r;
        },
        _notifications: function (_n) {
        	topic.publish("/event/notification_area/notify", _n);
        },
        Update: function (_data) {
            var t = this;
        //    console.log(t);
        if (t.idProperty &amp;&amp; t.idProperty.length > 0) {

           return t.request(_data, "update");                

       } else {
        console.warn('El idProperty es necesario para actualizaciones de registros');
        t.revert();
              // return t.Select(t._last_select);
          }
           // return t;
       },
       delete_selection: function () {
        return this.selected(null, 'delete_selection');
    },

    _grid_setData: function (_data) {
        var t = this;

            // console.log(w.getBox().h-65);
            //domStyle.set(t.Contenedor, 'height', w.getBox().h-120+'px');
            //console.log(t.Grid.collection);
            t._GridStore.setData(_data);
            //console.log(_data);
            t.set('collection', t._GridStore);

        //    console.log(_data);


        t.Filter(t._searchTerm);
       // t.revert();

           // t.refresh();
         //   t.resize();
           // t.set('enabledload', true);
           return t;
       },
       getProperties: function(){
         var t = this;

        	//console.log(this);
            if(t.uDCColumns.target &amp;&amp; t.uDCColumns.target.length > 0){

                var getCol = request.post(t.uDCColumns.target, {
                    data: {UdcTable: t.table, Fields: JSON.stringify(t.uDCColumns.fields)},
                    preventCache: true,
                            // Parse data from xml
                            handleAs: "javascript"
                        }
                        ).then(
                        function (response) {

                           var columns = [];

t.uDCProperties = response[0];

if(t.uDCProperties.dgrid_selectionmode){
   t.selectionMode = t.uDCProperties.dgrid_selectionmode;
}else{
   t.SelectionMode = "none";
}

array.forEach(t.uDCProperties.udc_column_definition, function(column, i){

    var c = column;

    if(c.editOn &amp;&amp; c.editOn == "dbclick" &amp;&amp; has("touch")){
        alert('Es touch');
        c.editOn = "click";
    }

// HorizontalSlider, VerticalSlider, NumberSpinner, TimeSpinner, CurrencyTextBox, DateTextBox, NumberTextBox, SimpleTextarea, Textarea, TimeTextBox

if(c.editor){
    switch(c.editor){
        case 'HorizontalSlider':
        c.editor = HorizontalSlider;
        break;
        case 'VerticalSlider':
        c.editor = VerticalSlider;
        break;
        case 'NumberSpinner':
        c.editor = NumberSpinner;
        break;
        case 'TimeSpinner':
        c.editor = TimeSpinner;
        break;
        case 'CurrencyTextBox':
        c.editor = CurrencyTextBox;
        break;
        case 'checkbox':
        c.editor = CheckBox;
        break;
        case 'DateTextBox':
        c.editor = DateTextBox;
        break;
        case 'NumberTextBox':
        c.editor = NumberTextBox;
        break;
        case 'SimpleTextarea':
        c.editor = SimpleTextarea;
        break;
        case 'Textarea':
        c.editor = Textarea;
        break;
        case 'TimeTextBox':
        c.editor = TimeTextBox;
        break;
        case 'Switch':
        c.editor = Switch;
        break;
        case 'FilteringSelectGlobalStore':
        c.editor = FilteringSelectGlobalStore;
        break;

        case 'FilteringSelect':
        c.editor = FilteringSelect;
        break;

        default:
        c.editor = 'text';
        break;
    }
}

if(array.indexOf(t.uDCColumns.fields, c.field) >= 0){
    columns.push(c);
}

});

//console.log(columns);

t.set('columns', columns);

t.resize();
//console.log('Deberia emitir el noteventos');
on.emit(t.domNode, 'dgrid-set-properties', {properties: t.uDCProperties});


},
function (error) {
    console.error(error + ' ' + t.target);
}
);

                        getCol.then(function (results) {
                        //   console.log('Se supone que se han seteado las columnas');
                                          //** Sirve para usar un filtro que buscara en todos los campos **//
                                          t._GridFieldsToFilter = [];
                                          for (var index in t.columns) {
                                            t._GridFieldsToFilter.push(t.columns[index].field);
                                        }

                                        t._enabledload = true;            	            
                                        t.Select(t.initialQuery);
                                    });        
                        
                    }else{
                        t._enabledload = true;  
                        console.log('Grid no tiene target para obtener la estructura');
                    }

                              
                },
                Clear: function () {
                    this._grid_setData([]);
                    return this;
                },
                uninitialize: function(){
                    var t = this;
                    console.debug('Llama para matar el uDCGrid');
	//clearInterval(t._IntervalRefresh);
//alert();
array.forEach(t._array_subscribe, function(s){
 s.remove();        
});

}



















}); 
});
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-account_contacts_users_account_contacts_users.html">account_contacts_users/account_contacts_users</a></li><li><a href="module-account_data_account_data.html">account_data/account_data</a></li><li><a href="module-account_equipments_account_equipments.html">account_equipments/account_equipments</a></li><li><a href="module-account_events_isopen_account_events_isopen.html">account_events_isopen/account_events_isopen</a></li><li><a href="module-uDC_uDC.html">uDC/uDC</a></li><li><a href="module-uDCGrid_uDCGrid.html">uDCGrid/uDCGrid</a></li></ul><h3>Classes</h3><ul><li><a href="uDC.html">uDC</a></li><li><a href="uDCGrid.html">uDCGrid</a></li></ul><h3>Events</h3><ul><li><a href="uDC.html#event:Loaded">Loaded</a></li></ul><h3>Namespaces</h3><ul><li><a href="myNameSpace.html">myNameSpace</a></li><li><a href="OpenMonitoringSystem.html">OpenMonitoringSystem</a></li></ul><h3>Global</h3><ul><li><a href="global.html"></a></li><li><a href="global.html#_setEventAttr">_setEventAttr</a></li><li><a href="global.html#ACK">ACK</a></li><li><a href="global.html#BINARY_ACK">BINARY_ACK</a></li><li><a href="global.html#BINARY_EVENT">BINARY_EVENT</a></li><li><a href="global.html#cache">cache</a></li><li><a href="global.html#connect">connect</a></li><li><a href="global.html#CONNECT">CONNECT</a></li><li><a href="global.html#decode">decode</a></li><li><a href="global.html#decodeBase64Packet">decodeBase64Packet</a></li><li><a href="global.html#decodePacket">decodePacket</a></li><li><a href="global.html#Decoder">Decoder</a></li><li><a href="global.html#deconstructPacket">deconstructPacket</a></li><li><a href="global.html#DISCONNECT">DISCONNECT</a></li><li><a href="global.html#eio">eio</a></li><li><a href="global.html#emit">emit</a></li><li><a href="global.html#encode">encode</a></li><li><a href="global.html#encodeBase64Packet">encodeBase64Packet</a></li><li><a href="global.html#encodePacket">encodePacket</a></li><li><a href="global.html#encodePayload">encodePayload</a></li><li><a href="global.html#encodePayloadAsArrayBuffer">encodePayloadAsArrayBuffer</a></li><li><a href="global.html#encodePayloadAsBlob">encodePayloadAsBlob</a></li><li><a href="global.html#encodeQueryString">encodeQueryString</a></li><li><a href="global.html#Encoder">Encoder</a></li><li><a href="global.html#ERROR">ERROR</a></li><li><a href="global.html#EVENT">EVENT</a></li><li><a href="global.html#events">events</a></li><li><a href="global.html#glob">glob</a></li><li><a href="global.html#has">has</a></li><li><a href="global.html#lookup">lookup</a></li><li><a href="global.html#Manager">Manager</a></li><li><a href="global.html#on">on</a></li><li><a href="global.html#parser">parser</a></li><li><a href="global.html#parseuri">parseuri</a></li><li><a href="global.html#polling">polling</a></li><li><a href="global.html#protocol">protocol</a></li><li><a href="global.html#reconstructPacket">reconstructPacket</a></li><li><a href="global.html#removeBlobs">removeBlobs</a></li><li><a href="global.html#Socket">Socket</a></li><li><a href="global.html#types">types</a></li><li><a href="global.html#url">url</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Sun Nov 20 2016 14:51:11 GMT-0500 (ECT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
