<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: oms.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: oms.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
     * Postgres custom methods
     *
     * @module postgres.oms
     */
define(['dojo/_base/declare',  "dojo/node!pg", "dojo/Evented", "dojo/Deferred", "dojo/_base/array", "dojo/promise/all"
	], function (declare, pg, Evented, Deferred, array, All) {

		return declare('postgres.oms', Evented, {

//  var conString = "pg://postgres:pg4321@192.168.238.66:5432/oms";
user: 'user',
pwd: 'pwd',
host: '127.0.0.1',
db: 'db',
port: 5432,
_last_ts: {},
tv_structure: {},
_last_notification_area: 0,

//////////////////////////////////
// The constructor
constructor: function(args) {
	this.port = 5432;
	dojo.safeMixin(this,args);
// this.inherited(arguments);
var t = this;
t._last_ts = {};
t._last_idnotify_notification_area = 0;
t.tv_structure= {};

setTimeout(function(){

	t.get_dgrid_fullstructure();

	setInterval(function(){

		var q = "SELECT table_name, ts FROM sys_table_ts;";
		pg.connect(t.connString(), (err, client, done) => {
    // Handle connection errors
    if(err) {
    	done();
    	console.log(err);
      //return res.status(500).json({success: false, data: err});
      return false;
  }

  var query = client.query(q);

  query.on('row', (row) => {

  	var newts = Date.parse(row.ts);

  	if(typeof t._last_ts[row.table_name] === 'undefined'){

  		t._last_ts[row.table_name] = newts;
  		t.get_tv_structure(row.table_name);
  		t.send_notification_area(row.table_name);
  		t.emit("tschange", {table_name: row.table_name,  ts: newts});

  	}else{

  		if(t._last_ts[row.table_name]  !=  newts){
  			t._last_ts[row.table_name] = newts;
  			t.get_tv_structure(row.table_name);
  			t.send_notification_area(row.table_name);
  			t.emit("tschange", {table_name: row.table_name,  ts: newts});
  		}

  	}


  });


  // After all data is returned, close connection and return results
  query.on('end', (result1) => {
  	done();
  });
  

});


	}, 1000);

}, 2000);

},
startup: function(){
	console.log('Startup');
}, 
///////////////////////////////////////////////////////////////
get_tv_structure: function(_tv){

	var t = this;

	if(_tv == 'udc_columns' || _tv == 'udc_tables_views'){
		t.get_dgrid_fullstructure();
	}

	return true;
},
///////////////////////////////////////////////////////////////
connString: function(){
	return "pg://"+this.user+":"+this.pwd+"@"+this.host+":"+this.port+"/"+this.db;
},
///////////////////////////////////////////////////////////////
query: function(_query, _param){

	console.log(_query);

	var deferred = new Deferred();

	var client = new pg.Client(this.connString());

	client.connect(function(error){
		if(error){
  //console.log(error);
  deferred.reject({pgClient: client, result: error});
}else{

	var query = client.query(_query, _param, function(error){
		if(error){
  //console.log(error);
  deferred.reject({pgClient: client, result: error});
}else{

	query.on("end", function (result) {
//result.rows.isString= function(){return false};
  // done();
  deferred.resolve({pgClient: client, result: result});

  client.end();
});

}
});


}
});
	return deferred.promise;
},
login: function(req, res){

	var t = this;

	var user = req.body.user || false;
	var pwd = req.body.pwd || false;
	var as = req.body.as || true;

	var q = "SELECT * from fun_general_login($1::TEXT, $2::TEXT, $3::TEXT, $4::INET, $5::BOOLEAN);";

	if(as == 'a'){
		as = true;
	}else{
		as = false;
	}

	return t.query(q, [user, pwd, req.headers['user-agent'], req.connection.remoteAddress, as]);
},
logout: function(req, res){

	var t = this;

	var q = "SELECT * from fun_general_login($1::TEXT, $2::TEXT, $3::TEXT, $4::INET, $5::BOOLEAN);";

	if(as == 'a'){
		as = true;
	}else{
		as = false;
	}

	return t.query(q, [user, pwd, req.headers['user-agent'], req.connection.remoteAddress, as]);
},
isLogged: function(req, res){
	return true;
},
get_notifications: function(req, res){


	var user = req.body.user || false;
	var client = new pg.Client(t.connString());
	client.on('error', function(error) {
		console.log(error);
	});     
	client.on('drain', client.end.bind(client)); 

	var query = client.query("SELECT * FROM notification_area WHERE (sessionid = 'all' OR sessionid = $1::text) AND idnotify > $2::integer ORDER BY urgency, idnotify", ['', 0]);

	query.on("row", function (row, result) {

  //  result.addRow(row);
});

	query.on('end', function() {
		console.log('query 2 completed');
	});


	client.connect();

},
send_notification_area: function(_table_notifications){

	var t = this;

	if(_table_notifications === "notification_area"){
//t._last_idnotify_notification_area
pg.connect(t.connString(), (err, client, done) => {
    // Handle connection errors
    if(err) {
    	done();
    	console.log(err);
      //return res.status(500).json({success: false, data: err});
      return false;
  }

  var query = client.query("SELECT * FROM notification_area WHERE idnotify > $1::integer ORDER BY idnotify;", [t._last_idnotify_notification_area]);

  query.on('row', (row) => {
  	t._last_idnotify_notification_area = row.idnotify;    
  	t.emit("notifying_the_user", row);
  });


// TODO: OJO si hay que cerrar esta conexion

  // After all data is returned, close connection and return results
  query.on('end', (result1) => {
  	done();
  });
  





});
}

},
response_insert: function(req, res, _query, _param){
	var t = this;
	pg.connect(t.connString(), (err, client, done) => {
		if(err) {
			done();
			console.log(err);
			res.status(500).json({success: false, data: err});
		}

				var query = client.query(_query, _param, (error)=>{
			if(error){
res.status(500).json({success: false, data: error, query: _query});
			}
		});
		query.on('end', (result) => {
			res.json({success: true, data: result});
			done();
		});

	});

},
response_query: function(req, res, _query, _param){
	var t = this;
	pg.connect(t.connString(), (err, client, done) => {
		if(err) {
			done();
			console.log(err);
			res.status(500).json({success: false, data: err});
		}

				var query = client.query(_query, _param, (error)=>{
			if(error){
res.status(500).json({success: false, data: error});
			}
		});

		query.on('end', (result) => {
			res.json(result.rows);
			done();
		});

	});

},
response_update: function(rea, res, _query, _param){
	var t = this;
	pg.connect(t.connString(), (err, client, done) => {
		if(err) {
			done();
			console.log(err);
			res.status(500).json({success: false, data: err});
		}

		var query = client.query(_query, _param, (error)=>{
			if(error){
res.status(500).json({success: false, data: error});
			}
		});

		query.on('end', (result) => {
			res.json({success: true, rowCount: result.rowCount});
			done();
		});

	});
}




});
});
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="postgres.module_oms.html">oms</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Sun Nov 20 2016 14:51:22 GMT-0500 (ECT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
