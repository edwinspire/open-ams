{"version":3,"file":"instrument.js","sourceRoot":"","sources":["../../../../src/lib/middleware/instrument.ts"],"names":[],"mappings":"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","sourcesContent":["import { stat, readFile } from 'fs';\nimport * as createError from 'http-errors';\nimport { lookup } from 'mime-types';\nimport { join, resolve } from 'path';\nimport { RequestHandler } from 'express';\n\nimport { Context } from '../Server';\n\nexport default function instrument(context: Context): RequestHandler {\n\tconst codeCache: {\n\t\t[filename: string]: { mtime: number; data: string };\n\t} = Object.create(null);\n\n\treturn (request, response, next) => {\n\t\tconst { basePath, executor } = context;\n\t\tconst wholePath = resolve(join(basePath, request.url));\n\n\t\tif (\n\t\t\t!(request.method === 'HEAD' || request.method === 'GET') ||\n\t\t\t!executor.shouldInstrumentFile(wholePath)\n\t\t) {\n\t\t\treturn next();\n\t\t}\n\n\t\tstat(wholePath, (error, stats) => {\n\t\t\t// The server was stopped before this file was served\n\t\t\tif (context.stopped) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (error || !stats.isFile()) {\n\t\t\t\texecutor.log('Unable to serve', wholePath, '(unreadable)');\n\t\t\t\treturn next(createError(404, error, { expose: false }));\n\t\t\t}\n\n\t\t\texecutor.log('Serving', wholePath);\n\n\t\t\tconst send = (contentType: string, data: string) => {\n\t\t\t\tresponse.writeHead(200, {\n\t\t\t\t\t'Content-Type': contentType,\n\t\t\t\t\t'Content-Length': Buffer.byteLength(data)\n\t\t\t\t});\n\t\t\t\tresponse.end(request.method === 'HEAD' ? '' : data, callback);\n\t\t\t};\n\t\t\tconst callback = (error?: Error) => {\n\t\t\t\tif (error) {\n\t\t\t\t\texecutor.emit(\n\t\t\t\t\t\t'error',\n\t\t\t\t\t\tnew Error(\n\t\t\t\t\t\t\t`Error serving ${wholePath}: ${error.message}`\n\t\t\t\t\t\t)\n\t\t\t\t\t);\n\t\t\t\t} else {\n\t\t\t\t\texecutor.log('Served', wholePath);\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tconst contentType = lookup(wholePath) || 'application/octet-stream';\n\t\t\tconst mtime = stats.mtime.getTime();\n\n\t\t\tif (codeCache[wholePath] && codeCache[wholePath].mtime === mtime) {\n\t\t\t\tsend(contentType, codeCache[wholePath].data);\n\t\t\t} else {\n\t\t\t\treadFile(wholePath, 'utf8', (error, data) => {\n\t\t\t\t\t// The server was stopped in the middle of the file read\n\t\t\t\t\tif (context.stopped) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (error) {\n\t\t\t\t\t\treturn next(createError(404, error, { expose: false }));\n\t\t\t\t\t}\n\n\t\t\t\t\t// providing `wholePath` to the instrumenter instead of a\n\t\t\t\t\t// partial filename is necessary because lcov.info requires\n\t\t\t\t\t// full path names as per the lcov spec\n\t\t\t\t\tdata = executor.instrumentCode(data, wholePath);\n\t\t\t\t\tcodeCache[wholePath] = {\n\t\t\t\t\t\t// strictly speaking mtime could reflect a previous\n\t\t\t\t\t\t// version, assume those race conditions are rare\n\t\t\t\t\t\tmtime,\n\t\t\t\t\t\tdata\n\t\t\t\t\t};\n\t\t\t\t\tsend(contentType, data);\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t};\n}\n"]}